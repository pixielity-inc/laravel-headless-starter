# ==============================================================================
# Laravel Queue Workers & Scheduler
# ==============================================================================
# Background job processing and scheduled task execution
#
# Usage:
#   docker-compose -f docker-compose.yml -f compose.workers.yml up -d
#
# Services:
#   - queue-worker: Processes background jobs
#   - scheduler: Runs scheduled tasks (cron jobs)
# ==============================================================================

services:
  queue-worker:
    env_file:
      - ../../environments/.env.docker
    build:
      context: ../..
      dockerfile: docker/Dockerfile
    # Note: container_name removed to allow replicas
    command: bin/artisan queue:work --tries=3 --timeout=90 --sleep=3 --max-jobs=1000
    environment:
      - APP_ENV=${APP_ENV:-production}
      - APP_DEBUG=${APP_DEBUG:-false}
      - DB_CONNECTION=${DB_CONNECTION:-sqlite}
      - QUEUE_CONNECTION=${QUEUE_CONNECTION:-database}
    volumes:
      - ../../storage:/var/www/html/storage
      - ../../database/database.sqlite:/var/www/html/database/database.sqlite
    restart: unless-stopped
    depends_on:
      - app
    networks:
      - laravel
    deploy:
      replicas: ${QUEUE_WORKER_REPLICAS:-2}

  scheduler:
    env_file:
      - ../../environments/.env.docker
    build:
      context: ../..
      dockerfile: docker/Dockerfile
    container_name: ${SCHEDULER_CONTAINER_NAME:-laravel-scheduler}
    command: >
      sh -c "while true; do
        bin/artisan schedule:run --verbose --no-interaction &
        sleep 60
      done"
    environment:
      - APP_ENV=${APP_ENV:-production}
      - APP_DEBUG=${APP_DEBUG:-false}
      - DB_CONNECTION=${DB_CONNECTION:-sqlite}
    volumes:
      - ../../storage:/var/www/html/storage
      - ../../database/database.sqlite:/var/www/html/database/database.sqlite
    restart: unless-stopped
    depends_on:
      - app
    networks:
      - laravel

  # Optional: Horizon for Redis queue management (requires laravel/horizon)
  # Uncomment if using Laravel Horizon
  # horizon:
  #   build:
  #     context: ../..
  #     dockerfile: docker/Dockerfile
  #   container_name: laravel-horizon
  #   command: bin/artisan horizon
  #   environment:
  #     - APP_ENV=${APP_ENV:-production}
  #     - APP_DEBUG=${APP_DEBUG:-false}
  #     - QUEUE_CONNECTION=redis
  #   volumes:
  #     - ../storage:/app/storage
  #   restart: unless-stopped
  #   depends_on:
  #     - app
  #     - redis
  #   networks:
  #     - laravel
